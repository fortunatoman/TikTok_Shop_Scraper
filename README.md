# TikTok Shop Product Analytics Pipeline

This Rails application implements an end-to-end pipeline that ingests **TikTok Shop Seller Center → Analytics → Product Analytics** data (product-level metrics) as **daily snapshots**, and exposes it via an API with filters.

## Architecture

The pipeline follows this flow:
1. **Fetcher** (Node.js) - Makes authenticated requests to TikTok Shop API
2. **Ingestion Service** - Processes and stores data in daily snapshots
3. **Query Service** - Aggregates and filters snapshot data
4. **API Endpoint** - Exposes filtered analytics data

---

## Part A: Network Request Discovery

### Endpoint

**URL:** `https://seller-us.tiktok.com/api/v2/insights/seller/ttp/product/list/v2`

**Method:** `POST`

**Path:** `/api/v2/insights/seller/ttp/product/list/v2`

### Query Parameters

- `locale`: Language locale (e.g., `en`)
- `language`: Language (e.g., `en`)
- `oec_seller_id`: Seller ID (e.g., `7496020242935155064`)
- `aid`: Application ID (e.g., `4068`)
- `app_name`: Application name (e.g., `i18n_ecom_shop`)
- `fp`: Fingerprint for verification
- `device_platform`: Platform (e.g., `web`)
- `cookie_enabled`: Boolean
- `screen_width`, `screen_height`: Screen dimensions
- `browser_language`: Browser language (e.g., `en-US`)
- `browser_platform`: Browser platform (e.g., `MacIntel`)
- `browser_name`: Browser name (e.g., `Mozilla`)
- `browser_version`: Browser version string
- `browser_online`: Boolean
- `timezone_name`: Timezone (e.g., `America/New_York`)
- `use_content_type_definition`: Integer (e.g., `1`)
- `msToken`: Security token (generated)
- `X-Bogus`: Security token (generated via encryption)
- `X-Gnarly`: Security token (generated via encryption)

### Request Body

```json
{
  "request": {
    "time_descriptor": {
      "start": "2025-12-17",
      "end": "2025-12-18",
      "timezone_offset": -28800
    },
    "ccr_available_date": "2025-12-15",
    "search": {
      "voc_statuses": [],
      "gmv_ranges": []
    },
    "filter": {},
    "list_control": {
      "rules": [
        {
          "direction": 2,
          "field": "gmv"
        }
      ],
      "pagination": {
        "size": 10,
        "page": 0
      }
    }
  }
}
```

### Response Structure

The API returns product-level data including:
- Product name/title
- Product ID (external_id)
- Image URL
- Status (live/hidden, etc.)
- GMV (Gross Merchandise Value)
- Items sold
- Number of orders
- Stock status
- Additional metrics (shop tab page views, impressions, etc.)

### Headers Required

- `accept: */*`
- `accept-language: en-US,en;q=0.9`
- `content-type: application/json`
- `origin: https://seller-us.tiktok.com`
- `referer: https://seller-us.tiktok.com/compass/product-analysis?...`
- `user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36...`
- `cookie: [session cookies]`

### Special Tokens

The request requires three special tokens that must be generated:
1. **msToken**: Can be extracted from cookies or generated
2. **X-Bogus**: Generated using encryption algorithm (see `encryption/xbogus.mjs`)
3. **X-Gnarly**: Generated using encryption algorithm (see `encryption/xgnarly.mjs`)

These tokens are generated by the JavaScript fetcher using the provided encryption modules.

---

## Setup Instructions

### Prerequisites

- Ruby 3.0+ (recommended: 3.1+)
- Rails 7.0+
- Node.js 16+ (for running JavaScript fetchers)
- PostgreSQL (or your preferred database)

### Installation

1. **Install dependencies:**

```bash
bundle install
npm install --prefix app/javascript
```

2. **Set up the database:**

```bash
rails db:create
rails db:migrate
```

3. **Configure environment variables:**

Create `.env` file (or set in your environment):

```bash
# TikTok Shop credentials
TIKTOK_SHOP_COOKIE=your_cookie_string_here
TIKTOK_SHOP_OEC_SELLER_ID=your_seller_id_here
TIKTOK_SHOP_BASE_URL=https://seller-us.tiktok.com
TIKTOK_SHOP_FP=your_fingerprint_here
```

### Encryption Files

**⚠️ IMPORTANT:** The encryption files (`xbogus.mjs` and `xgnarly.mjs`) are **required** but not included in this repository.

**Action Required:**
1. Download from: https://github.com/justbeluga/tiktok-web-reverse-engineering/tree/main/encryption
2. Place them in:
   - `app/javascript/encryption/xbogus.mjs`
   - `app/javascript/encryption/xgnarly.mjs`
3. Replace the placeholder files that are currently there

**See `MANUAL_STEPS.md` for detailed setup instructions.**

---

## Usage

### 1. Sync Product Analytics Data

To sync product analytics for a date range:

```ruby
# In Rails console or a worker
TikTokShopServices::SyncProductAnalytics.call(
  tik_tok_shop_id: 1,
  start_date: Date.parse('2025-11-01'),
  end_date: Date.parse('2025-11-30')
)
```

This will:
- Fetch product data from TikTok Shop API
- Upsert products into `tik_tok_shop_products` table
- Create daily snapshots in `tik_tok_shop_product_snapshots` table
- Handle pagination automatically
- Be idempotent (safe to run multiple times)

### 2. Query Product Analytics via API

**Endpoint:** `GET /api/v1/tik_tok_shops/:id/product_analytics`

**Query Parameters:**
- `start_date` (required): Start date in YYYY-MM-DD format
- `end_date` (required): End date in YYYY-MM-DD format
- `min_gmv` (optional): Minimum GMV filter in dollars (e.g., `1000`)

**Example Request:**

```bash
curl "http://localhost:3000/api/v1/tik_tok_shops/1/product_analytics?start_date=2025-11-01&end_date=2025-11-30&min_gmv=1000"
```

**Example Response:**

```json
{
  "data": [
    {
      "external_id": "123456789",
      "title": "Product A",
      "status": "live",
      "image_url": "https://...",
      "gmv": 2450.10,
      "items_sold": 88,
      "orders_count": 70
    }
  ]
}
```

### 3. Backfill Historical Data

To backfill data for the last 30 days:

```ruby
start_date = 30.days.ago.to_date
end_date = Date.today

TikTokShop::SyncProductAnalytics.call(
  tik_tok_shop_id: 1,
  start_date: start_date,
  end_date: end_date
)
```

---

## Database Schema

### `tik_tok_shop_products`

Stores static product attributes.

- `id` (primary key)
- `tik_tok_shop_id` (foreign key)
- `external_id` (TikTok product ID)
- `title`
- `image_url`
- `status` (live/hidden/etc.)
- `stock` (integer)
- `created_at`, `updated_at`

**Unique constraint:** `(tik_tok_shop_id, external_id)`

### `tik_tok_shop_product_snapshots`

Stores daily metrics (one row per product per day).

- `id` (primary key)
- `tik_tok_shop_id` (foreign key)
- `tik_tok_shop_product_id` (foreign key)
- `snapshot_date` (date)
- `gmv` (decimal)
- `items_sold` (integer)
- `orders_count` (integer)
- `created_at`, `updated_at`

**Unique constraint:** `(tik_tok_shop_product_id, snapshot_date)`

This ensures idempotency: re-running sync jobs won't create duplicates.

---

## Project Structure

```
app/
  controllers/
    api/v1/
      tik_tok_shops_controller.rb
  javascript/
    encryption/
      xbogus.mjs
      xgnarly.mjs
    products.mjs
    products-raw.mjs
  models/
    tik_tok_shop.rb
    tik_tok_shop_product.rb
    tik_tok_shop_product_snapshot.rb
  services/
    sign_params_service.rb
    tik_tok_shop/
      sync_product_analytics.rb
      product_analytics_query.rb
db/
  migrate/
    [timestamp]_create_tik_tok_shop_products.rb
    [timestamp]_create_tik_tok_shop_product_snapshots.rb
```

---

## How It Works

### Data Flow

1. **Fetcher** (`products-raw.mjs`):
   - Generates X-Bogus and X-Gnarly tokens
   - Constructs authenticated request to TikTok Shop API
   - Handles pagination
   - Returns raw API response

2. **Sign Params Service** (`sign_params_service.rb`):
   - Ruby wrapper that calls Node.js fetcher
   - Passes parameters via stdin
   - Returns parsed JSON response

3. **Sync Service** (`TikTokShop::SyncProductAnalytics`):
   - Calls fetcher for each day in date range
   - Parses response and extracts product data
   - Upserts products (by external_id)
   - Upserts daily snapshots (by product_id + date)
   - Handles errors and retries

4. **Query Service** (`TikTokShop::ProductAnalyticsQuery`):
   - Queries snapshots for date range
   - Aggregates metrics (sum GMV, items_sold, orders_count)
   - Filters by min_gmv threshold
   - Joins with product data

5. **API Controller**:
   - Validates parameters
   - Calls query service
   - Returns JSON response

---

## Tradeoffs & Design Decisions

### Daily Snapshots vs Aggregates

- **Decision:** Store daily snapshots, not monthly aggregates
- **Rationale:** Allows flexible date range queries and historical analysis
- **Tradeoff:** More storage, but enables time-series analysis

### Idempotency

- **Decision:** Use unique constraints on (product_id, snapshot_date)
- **Rationale:** Safe to re-run sync jobs without duplicates
- **Tradeoff:** Requires careful upsert logic

### Pagination Handling

- **Decision:** Fetch all pages automatically in fetcher
- **Rationale:** Ensures complete data capture
- **Tradeoff:** May take longer for large datasets

### JavaScript Fetcher

- **Decision:** Use Node.js for TikTok API calls
- **Rationale:** Encryption libraries are in JavaScript
- **Tradeoff:** Requires Node.js runtime, but keeps encryption logic isolated

---

## Testing

### Manual Testing

1. **Test fetcher:**
```bash
node app/javascript/products.mjs
```

2. **Test sync service:**
```ruby
rails console
TikTokShop::SyncProductAnalytics.call(tik_tok_shop_id: 1, start_date: Date.today, end_date: Date.today)
```

3. **Test API:**
```bash
rails server
curl "http://localhost:3000/api/v1/tik_tok_shops/1/product_analytics?start_date=2025-12-17&end_date=2025-12-17"
```

---

## Troubleshooting

### Common Issues

1. **"Request failed: Invalid token"**
   - Check that cookies are valid and not expired
   - Verify X-Bogus/X-Gnarly generation is working

2. **"Duplicate key error"**
   - This is expected - the unique constraints prevent duplicates
   - The upsert should handle this gracefully

3. **"Node.js not found"**
   - Ensure Node.js is installed and in PATH
   - Verify with: `node --version`

4. **"Encryption files not found"**
   - Ensure `xbogus.mjs` and `xgnarly.mjs` are in `app/javascript/encryption/`
   - Download from the GitHub repository if missing

---

## Next Steps / Future Improvements

- [ ] Add background job processing (Sidekiq/ActiveJob)
- [ ] Add rate limiting for API requests
- [ ] Add caching for frequently queried date ranges
- [ ] Add webhook support for real-time updates
- [ ] Add more filter options (status, stock, etc.)
- [ ] Add export functionality (CSV, Excel)
- [ ] Add monitoring and alerting

---

## License

[Your License Here]

